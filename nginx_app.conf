location ~* ^/cdn/(.*?)/(.*) {
  set $aws_access_key   'AWSAccessKeyId=$arg_AWSAccessKeyId';
  set $url_expires      'Expires=$arg_Expires';
  set $url_signature    'Signature=$arg_Signature';

  resolver 8.8.8.8;
  proxy_set_header HOST $remote_host;
  proxy_pass https://$1/$2?$aws_access_key&$url_expires&$url_signature';
}

location / {
  # try to serve file directly, fallback to rewrite
  try_files $uri @rewriteapp;
}

location @rewriteapp {
  # rewrite all to index.php
  rewrite ^(.*)$ /index.php/$1 last;
}

location ~ ^/index\.php(/|$) {
  try_files @heroku-fcgi @heroku-fcgi;
  internal;
}